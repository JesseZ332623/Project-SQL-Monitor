services:
  # 主数据库
  mysql-master:
    image: mysql:8
    container_name: mysql-master-ci
    environment:
      MYSQL_ROOT_PASSWORD: 123456 # 这个后面要放在仓库的 Security 里面
    ports:
      - "3433:3306"
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --performance-schema=OFF         # 禁用性能模式减少内存
      - --innodb-buffer-pool-size=128M   # 减小缓冲池大小
      - --innodb-log-file-size=48M       # 减小日志文件大小
      - --max-connections=100            # 限制连接数
      - --server-id=1
      - --log-bin=mysql-bin
      - --binlog-format=ROW
      - --sync-binlog=1
    healthcheck:
      test: ["CMD", "mysql", "-uroot", "-p123456", "-e", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped

    # 从数据库
  mysql-slaver:
    image: mysql:8
    container_name: mysql-slaver-ci
    environment:
      MYSQL_ROOT_PASSWORD: root_password  # 临时 root 密码
      MYSQL_DATABASE: sql_monitor  # 对应 slaver.default-schema
      MYSQL_USER: Jesse_EC233      # 对应 slaver.user
      MYSQL_PASSWORD: 3191955858_EC # 对应 slaver.password
    ports:
      - "3307:3306"
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --performance-schema=OFF         # 禁用性能模式减少内存
      - --performance-schema=OFF         # 禁用性能模式减少内存
      - --innodb-buffer-pool-size=128M   # 减小缓冲池大小
      - --innodb-log-file-size=48M       # 减小日志文件大小
      - --max-connections=100            # 限制连接数
      - --server-id=2
      - --relay-log=relay-log
    healthcheck:
      test: ["CMD", "mysql", "-uJesse_EC233", "-p3191955858_EC", "-e", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped
    # 需要等主库启动后再启动从库
    depends_on:
      mysql-master:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: redis-ci
    environment:
      REDIS_USERNAME: Jesse       # 对应 redis.username
      REDIS_PASSWORD: 1234567890  # 对应 redis.password
    command:
      - redis-server
      - --requirepass 1234567890  # 设置 Redis 密码
      - --appendonly yes
    ports:
      - "6380:6379"
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli", "-a", "1234567890", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq-ci
    environment:
      RABBITMQ_DEFAULT_USER: jesse          # 对应 rabbitmq.user
      RABBITMQ_DEFAULT_PASS: 1234567890     # 对应 rabbitmq.password
      RABBITMQ_DEFAULT_VHOST: /             # 对应 rabbitmq.virtualhost
    ports:
      - "5673:5672"   # AMQP 协议
      - "15673:15672" # 管理界面
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics", "ping" ]
      interval: 10s
      timeout: 15s
      retries: 5
    restart: unless-stopped