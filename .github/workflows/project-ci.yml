name: Backend Modules CI # 后端模块 CI 测试

on:
  push:
    branches: [ develop, main ] # 尝试推送到这两个分支时会触发 CI 测试
  pull_request:
    branches: [ develop, main ] # 尝试对这两个分支发起 PS 时也会触发 CI 测试

jobs:
  test-backend:
    runs-on: ubuntu-latest # 在最新版的 Ubuntu 虚拟机上运行

    steps:
      # 检查系统资源
      - name: Check system resources
        run: |
          echo "System info:"
          free -h
          df -h
          docker info

      - name: Checkout repository
        # 该 Action 将仓库的代码检出到 runner 的工作目录（相当于 git clone）
        uses: actions/checkout@v4

      # 安装 Docker Compose
      - name: Set up Docker Compose
        run: |
          echo "Installing Docker Compose..."
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.40.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

        # 启用 Docker 容器（部署中间件服务）
      - name: Start service with Docker Compose
        run: docker-compose -f docker-compose.test.yml up -d

      # 等待所有服务初始化完毕
      - name: Wait for service
        run: |
          echo "Waiting for MySQL master to be ready..."
          for i in {1..60}; do
            if docker-compose -f docker-compose.test.yml exec -T mysql-master mysqladmin ping -h127.0.0.1 -uroot -p123456 >/dev/null 2>&1; then
              echo "MySQL master is ready!"
              break
            fi
            echo "Waiting for master... ($i/60)"
            sleep 3
          done
      
          echo "Waiting for MySQL slave to be ready..."
          for i in {1..60}; do
            if docker-compose -f docker-compose.test.yml exec -T mysql-slaver mysqladmin ping -h127.0.0.1 -uJesse_EC233 -p3191955858_EC >/dev/null 2>&1; then
              echo "MySQL slave is ready!"
              break
            fi
            echo "Waiting for slave... ($i/60)"
            sleep 3
          done
      
          echo "All services are ready!"
          docker-compose -f docker-compose.test.yml ps

      - name: Initialize test databases
        run: |
          echo "Initialize slaver database..."
          # 将 SQL 语句写入临时文件
          cat > /tmp/init_slave.sql << 'EOF'
          CREATE DATABASE IF NOT EXISTS `sql_monitor`;
          USE `sql_monitor`;
          CREATE TABLE `monitor_log` (
          `log_id` bigint NOT NULL,
          `datetime` datetime NOT NULL,
          `indicator` varchar(255) NOT NULL,
          `server_ip` int unsigned NOT NULL,
          `indicator_type` enum('ConnectionUsage','DatabaseSize','InnodbBufferCacheHitRate','NetWorkTraffic','QPSResult') NOT NULL,
          `qps_value` decimal(15,8) GENERATED ALWAYS AS ((case when (json_unquote(json_extract(`indicator`,_utf8mb4'$.type')) = _utf8mb4'qps') then cast(json_unquote(json_extract(`indicator`,_utf8mb4'$.qps')) as decimal(15,8)) end)) VIRTUAL,
          `current_connections` int GENERATED ALWAYS AS ((case when (json_unquote(json_extract(`indicator`,_utf8mb4'$.type')) = _utf8mb4'connectionUsage') then cast(json_unquote(json_extract(`indicator`,_utf8mb4'$.currentConnections')) as unsigned) end)) VIRTUAL,
          `cacheHitRate` decimal(15,8) GENERATED ALWAYS AS ((case when (json_unquote(json_extract(`indicator`,_utf8mb4'$.type')) = _utf8mb4'innodbBufferCacheHitRate') then cast(json_unquote(json_extract(`indicator`,_utf8mb4'$.cacheHitRate')) as decimal(15,8)) end)) VIRTUAL,
          `receivePerSec` decimal(15,8) GENERATED ALWAYS AS ((case when (json_unquote(json_extract(`indicator`,_utf8mb4'$.type')) = _utf8mb4'networkTraffic') then cast(json_unquote(json_extract(`indicator`,_utf8mb4'$.receivePerSec')) as decimal(15,8)) end)) VIRTUAL,
          `sentPerSec` decimal(15,8) GENERATED ALWAYS AS ((case when (json_unquote(json_extract(`indicator`,_utf8mb4'$.type')) = _utf8mb4'networkTraffic') then cast(json_unquote(json_extract(`indicator`,_utf8mb4'$.sentPerSec')) as decimal(15,8)) end)) VIRTUAL,
          PRIMARY KEY (`log_id`),
          KEY `idx_ip_type_datetime` (`server_ip`,`indicator_type`,`datetime`),
          KEY `datetime_idx` (`datetime`),
          KEY `idx_qps` (`qps_value`),
          KEY `idx_current_connections` (`current_connections`),
          KEY `idx_cache_hitrate` (`cacheHitRate`),
          KEY `idx_network_traffic` (`receivePerSec`,`sentPerSec`)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
          EOF
    
          # 执行 SQL 文件
          docker-compose -f docker-compose.test.yml exec -T mysql-slaver mysql -uJesse_EC233 -p3191955858_EC < /tmp/init_slave.sql
          
          # 验证表是否创建成功
          docker-compose -f docker-compose.test.yml exec -T mysql-slaver mysql -uJesse_EC233 -p3191955858_EC -e "SHOW TABLES IN sql_monitor;"

      - name: Setup Java and Maven
        # 该 Action 安装指定版本的 JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'       # Java 版本
          # 发行版本，可以是
          # 'temurin'  Eclipse 基金会开源，社区维护
          # 'corretto' AWS 维护
          # 'zulu'     Azul Systems 维护
          # 'openjdk'  Oracle 官方 OpenJDK
          distribution: 'temurin'

      - name: Cache Maven dependencies
        # 该 Action 用于缓存依赖项，加快构建的速度
        uses: actions/cache@v3
        with:
          # 缓存所有下载的依赖和所有模块的构建目录
          path: |
            ~/.m2/repository
            */target
          # 将缓存保存到 Github 服务器（使用 key 查找）
          # 只要项目内的任何一个 pom.xml 文件发生变动，都会创建新缓存
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          # 后备匹配机制，如果匹配 key 失败，则会尝试匹配 restore-keys 属性设置的键
          restore-keys: |
            ${{ runner.os }}-maven-

        # mvn clean compile test -B
        # 命令中的 -B 选项意味批处理模式 (--batch-mode) 不显示下载进度
        #
        # find indicator_receiver/target/surefire-reports \
        # -name "*.txt" -exec echo " - {}" \; 2>/dev/null || echo " No test report"
        # 在指定目录查找所有文本文件并 echo 它的路径，将错误信息重定向到空设备（忽略错误信息）
        # 如果在指定目录下没找到任何文本文件，则输出 No test report
      - name: Build and test all modules
        env:
          SPRING_R2DBC_URL: r2dbc:mysql://localhost:3307/sql_monitor?useSSL=false&allowPublicKeyRetrieval=true  # MySQL slave 的 URL，添加参数避免 SSL/认证问题
          SPRING_R2DBC_USERNAME: Jesse_EC233
          SPRING_R2DBC_PASSWORD: 3191955858_EC
          SPRING_RABBITMQ_HOST: localhost
          SPRING_RABBITMQ_PORT: 5673
          SPRING_RABBITMQ_USERNAME: jesse
          SPRING_RABBITMQ_PASSWORD: 1234567890
        run: |
          echo "=== Start to build and test all backend modules ==="
          
          echo "--- Test module indicator_receiver ---"
          cd indicator_receiver
          mvn clean compile test -B
          cd ..

          echo "--- Test module sql-monitor ---"
          cd sql-monitor
          mvn clean compile test -B
          cd ..
          
          echo "=== All test complete ==="

      # 生成测试报告摘要
      - name: Generate test reports
        if: always()
        run: |
          echo "Conclusion of test report"
          
          echo "1. Module indicator_report: "
          find indicator_receiver/target/surefire-reports -name "*.txt" -exec echo " - {}" \; 2>/dev/null || echo " No test report"
          
          echo "2. Module sql-monitor: "
          find sql-monitor/target/surefire-reports -name "*.txt" -exec echo " - {}" \; 2>/dev/null || echo " No test report"

      # 生成 JaCoCo 测试覆盖率报告
      - name: Generate JaCoCo coverage report
        run: |
          cd indicator_receiver
          mvn jacoco:report
          cd ../sql-monitor
          mvn jacoco:report

      # 保存测试覆盖率报告
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            indicator_receiver/target/site/jacoco
            sql-monitor/target/site/jacoco
          retention-days: 90 # 保留 90 天（默认）

      # 清理并关闭 Docker 容器
      - name: Docker cleanup
        if: always()
        run: docker-compose -f docker-compose.test.yml down -v
